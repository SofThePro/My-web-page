<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Flappy Bird Pro + Math Mode</title>

<style>
:root{color-scheme:dark}
body{
  margin:0;
  background:#0b1220;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  font-family:system-ui;
  overflow:hidden;
}

#game{
  background:linear-gradient(#66c8ff,#c8f2ff 65%,#7bd67b 65%);
  border-radius:16px;
  box-shadow:0 20px 50px rgba(0,0,0,.5);
  touch-action:none;
}

.hud{
  position:fixed;
  top:15px;
  width:100%;
  display:flex;
  justify-content:center;
  gap:12px;
  z-index:10;
}

.pill{
  padding:8px 14px;
  border-radius:999px;
  background:rgba(255,255,255,.1);
  border:1px solid rgba(255,255,255,.2);
  color:#fff;
  cursor:pointer;
}

#mathOverlay{
  position:fixed;
  inset:0;
  background:#000;
  color:#fff;
  display:none;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:999;
}

#mathOverlay h1{
  margin:10px 0;
}

#mathOverlay input{
  padding:12px;
  font-size:20px;
  border-radius:10px;
  border:none;
  text-align:center;
  width:120px;
}

#mathOverlay button{
  margin-top:15px;
  padding:10px 20px;
  border-radius:10px;
  border:none;
  font-size:16px;
  cursor:pointer;
}

.timer{
  font-size:18px;
  margin-top:10px;
  opacity:.8;
}
</style>
</head>
<body>

<div class="hud">
  <div class="pill">Score: <span id="score">0</span></div>
  <div class="pill" id="mathBtn">Math Mode</div>
  <div class="pill" id="restartBtn">Restart</div>
</div>

<canvas id="game" width="420" height="640"></canvas>

<!-- FULLSCREEN MATH -->
<div id="mathOverlay">
  <h1>Advanced Math Challenge</h1>
  <div id="question" style="font-size:28px;margin:10px;"></div>
  <input id="answer" type="number">
  <button id="submitAnswer">Submit</button>
  <div class="timer" id="timer"></div>
  <div id="result" style="margin-top:20px;font-size:18px;"></div>
</div>

<script>
/* =========================
   FLAPPY BIRD CORE
========================= */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const scoreEl = document.getElementById("score");

const W = canvas.width;
const H = canvas.height;

const GRAVITY = 0.45;
const FLAP = -8;
const PIPE_WIDTH = 70;
const PIPE_GAP = 170;
const PIPE_SPACE = 220;
const GROUND = 80;

const State = {READY:0, PLAYING:1, GAMEOVER:2, PAUSED:3};
let state = State.READY;
let prevState = State.READY;
let resumeLock=false;

let score=0;
let best=Number(localStorage.getItem("best")||0);

const bird={x:120,y:H*0.45,r:16,vy:0};
let pipes=[];

function rand(a,b){return Math.random()*(b-a)+a}

function reset(){
  state=State.READY;
  score=0;
  scoreEl.textContent=0;
  bird.y=H*0.45;
  bird.vy=0;
  pipes=[];
  for(let i=0;i<4;i++){
    spawnPipe(W+120+i*PIPE_SPACE);
  }
}

function spawnPipe(x){
  const top=rand(80,H-GROUND-PIPE_GAP-80);
  pipes.push({x,top,passed:false});
}

function flap(){
  if(state!==State.PLAYING && state!==State.READY) return;
  if(resumeLock) return;
  if(state===State.READY) state=State.PLAYING;
  bird.vy=FLAP;
}

function collide(cx,cy,r,rx,ry,rw,rh){
  const x=Math.max(rx,Math.min(cx,rx+rw));
  const y=Math.max(ry,Math.min(cy,ry+rh));
  const dx=cx-x,dy=cy-y;
  return dx*dx+dy*dy<=r*r;
}

function update(){
  if(state!==State.PLAYING) return;

  bird.vy+=GRAVITY;
  bird.y+=bird.vy;

  const speed=2.6+score*0.05;

  for(const p of pipes) p.x-=speed;

  if(pipes[0].x+PIPE_WIDTH<-20){
    pipes.shift();
    spawnPipe(pipes[pipes.length-1].x+PIPE_SPACE);
  }

  for(const p of pipes){
    if(!p.passed && p.x+PIPE_WIDTH<bird.x){
      p.passed=true;
      score++;
      scoreEl.textContent=score;
    }
  }

  if(bird.y+bird.r>=H-GROUND||bird.y-bird.r<=0){
    state=State.GAMEOVER;
  }

  for(const p of pipes){
    if(collide(bird.x,bird.y,bird.r,p.x,0,PIPE_WIDTH,p.top)||
       collide(bird.x,bird.y,bird.r,p.x,p.top+PIPE_GAP,
       PIPE_WIDTH,H-GROUND-(p.top+PIPE_GAP))){
         state=State.GAMEOVER;
       }
  }

  if(state===State.GAMEOVER){
    best=Math.max(best,score);
    localStorage.setItem("best",best);
  }
}

function draw(){
  ctx.clearRect(0,0,W,H);

  ctx.fillStyle="#4db84d";
  ctx.fillRect(0,H-GROUND,W,GROUND);

  ctx.fillStyle="#36d45c";
  for(const p of pipes){
    ctx.fillRect(p.x,0,PIPE_WIDTH,p.top);
    ctx.fillRect(p.x,p.top+PIPE_GAP,
      PIPE_WIDTH,H-GROUND-(p.top+PIPE_GAP));
  }

  ctx.fillStyle="#ffd23c";
  ctx.beginPath();
  ctx.arc(bird.x,bird.y,bird.r,0,Math.PI*2);
  ctx.fill();

  if(state===State.PLAYING){
    ctx.fillStyle="#fff";
    ctx.font="bold 42px system-ui";
    ctx.textAlign="center";
    ctx.fillText(score,W/2,90);
  }

  if(state!==State.PLAYING){
    ctx.fillStyle="rgba(0,0,0,.4)";
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle="#fff";
    ctx.font="bold 36px system-ui";
    ctx.textAlign="center";
    ctx.fillText(
      state===State.GAMEOVER?"Game Over":"Flappy Bird",
      W/2,200
    );
    ctx.font="18px system-ui";
    ctx.fillText("Tap or Space to Play",W/2,240);
  }
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}

/* =========================
   FULLSCREEN MATH MODE
========================= */

const overlay=document.getElementById("mathOverlay");
const questionEl=document.getElementById("question");
const answerEl=document.getElementById("answer");
const timerEl=document.getElementById("timer");
const resultEl=document.getElementById("result");

let total=10;
let correct=0;
let currentAnswer=0;
let time=60;
let timerInterval;

function newQuestion(){
  const ops=["+","-","*","/"];
  const op=ops[Math.floor(Math.random()*ops.length)];
  let a=Math.floor(rand(2,20));
  let b=Math.floor(rand(2,20));

  if(op==="/"){
    currentAnswer=a;
    b=Math.floor(rand(2,12));
    a=currentAnswer*b;
  }else if(op==="*"){
    currentAnswer=a*b;
  }else if(op==="+"){
    currentAnswer=a+b;
  }else{
    if(b>a)[a,b]=[b,a];
    currentAnswer=a-b;
  }

  questionEl.textContent=`${a} ${op} ${b} = ?`;
  answerEl.value="";
  answerEl.focus();
}

function startMath(){
  prevState=state;
  state=State.PAUSED;
  resumeLock=true;

  overlay.style.display="flex";
  correct=0;
  time=60;
  resultEl.textContent="";
  newQuestion();

  timerInterval=setInterval(()=>{
    time--;
    timerEl.textContent=`Time Left: ${time}s`;
    if(time<=0) finishMath();
  },1000);
}

function submitAnswer(){
  if(Number(answerEl.value)===currentAnswer){
    correct++;
  }
  newQuestion();
}

function finishMath(){
  clearInterval(timerInterval);
  let grade=correct>=8?"A":
            correct>=6?"B":
            correct>=4?"C":"Fail";

  resultEl.innerHTML=`Score: ${correct}/${total}<br>Grade: ${grade}`;

  if(grade==="A"||grade==="B"){
    score+=10;
    scoreEl.textContent=score;
  }

  setTimeout(()=>{
    overlay.style.display="none";
    state=prevState;
    resumeLock=false;
  },3000);
}

document.getElementById("mathBtn").onclick=startMath;
document.getElementById("submitAnswer").onclick=submitAnswer;
answerEl.addEventListener("keydown",e=>{
  if(e.key==="Enter") submitAnswer();
});
document.getElementById("restartBtn").onclick=reset;

canvas.addEventListener("pointerdown",flap);
window.addEventListener("keydown",e=>{
  if(e.code==="Space"){e.preventDefault();flap();}
  if(e.key==="r") reset();
});

reset();
loop();
</script>

</body>
</html>
